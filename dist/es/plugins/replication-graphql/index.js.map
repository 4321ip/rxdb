{"version":3,"sources":["../../../../src/plugins/replication-graphql/index.ts"],"names":["body","recover","result","e","then","pact","state","value","s","v","o","bind","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","array","check","i","reject","_cycle","length","test","update","stage","shouldContinue","updateValue","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","BehaviorSubject","Subject","firstValueFrom","filter","GraphQLClient","objectPath","promiseWait","getHeightOfRevision","flatClone","PROMISE_RESOLVE_FALSE","PROMISE_RESOLVE_TRUE","PROMISE_RESOLVE_VOID","addRxPlugin","hash","DEFAULT_MODIFIER","wasRevisionfromPullReplication","createRevisionForPulledDocument","setLastPushSequence","getLastPullDocument","setLastPullDocument","getChangesSinceLastPushSequence","RxDBLeaderElectionPlugin","overwritable","getDocumentDataOfRxChangeEvent","_handleToStorageInstance","RxGraphQLReplicationState","collection","url","headers","pull","push","deletedFlag","live","liveInterval","retryTime","_subjects","received","send","error","canceled","active","initialReplicationComplete","_runningPromise","_subs","_runQueueCount","_runCount","initialReplicationComplete$","undefined","received$","send$","error$","canceled$","active$","client","endpointHash","_prepare","onDestroy","cancel","Object","keys","forEach","key","defineProperty","get","asObservable","isStopped","destroyed","getValue","awaitInitialReplication","pipe","run","retryOnFail","next","_run","willRetry","runPull","ok","setTimeout","runPush","database","requestIdlePromise","latestDocument","latestDocumentData","queryBuilder","pullGraphQL","dataPath","data","Promise","all","map","doc","modifier","modified","isDevMode","withoutDeleteFlag","schema","validate","err","handleDocumentsFromRemote","newLatestDocument","query","variables","errors","Error","innerErrors","batchSize","changesResult","Array","from","changedDocs","values","row","changedDoc","sequence","lastSequence","size","changesWithDocs","lastSuccessfullChange","changeWithDoc","hasOwnProperty","_deleted","pushObj","docs","toStorageDocs","docIds","primaryPath","lockedRun","storageInstance","findDocumentsById","docsFromLocal","documentId","deletedValue","docStateInLocalStorageInstance","newRevision","hasHeight","_rev","newRevisionHeight","bulkAddRevisions","sub","unsubscribe","setHeaders","syncGraphQL","waitForLeadership","autoStart","replicationState","waitTillRun","multiInstance","changeEventsSub","$","cE","isLocal","subscribe","changeEvent","rev","rxdb","prototypes","RxCollection","proto","RxDBReplicationGraphQLPlugin","name"],"mappings":"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","sourcesContent":["/**\n * this plugin adds the RxCollection.syncGraphQl()-function to rxdb\n * you can use it to sync collections with remote graphql endpoint\n */\n\nimport {\n    BehaviorSubject,\n    Subject,\n    Subscription,\n    Observable,\n    firstValueFrom\n} from 'rxjs';\nimport {\n    filter\n} from 'rxjs/operators';\nimport GraphQLClient from 'graphql-client';\nimport objectPath from 'object-path';\nimport {\n    promiseWait,\n    getHeightOfRevision,\n    flatClone,\n    PROMISE_RESOLVE_FALSE,\n    PROMISE_RESOLVE_TRUE,\n    PROMISE_RESOLVE_VOID\n} from '../../util';\n\nimport {\n    addRxPlugin\n} from '../../core';\nimport {\n    hash\n} from '../../util';\n\nimport {\n    DEFAULT_MODIFIER,\n    wasRevisionfromPullReplication,\n    createRevisionForPulledDocument\n} from './helper';\nimport {\n    setLastPushSequence,\n    getLastPullDocument,\n    setLastPullDocument,\n    getChangesSinceLastPushSequence\n} from './crawling-checkpoint';\n\nimport { RxDBLeaderElectionPlugin } from '../leader-election';\nimport {\n    overwritable\n} from '../../overwritable';\nimport type {\n    RxCollection,\n    GraphQLSyncPullOptions,\n    GraphQLSyncPushOptions,\n    RxPlugin,\n    RxDocumentData\n} from '../../types';\nimport { getDocumentDataOfRxChangeEvent } from '../../rx-change-event';\nimport {\n    _handleFromStorageInstance,\n    _handleToStorageInstance\n} from '../../rx-collection-helper';\n\naddRxPlugin(RxDBLeaderElectionPlugin);\n\n\nexport class RxGraphQLReplicationState<RxDocType> {\n\n    constructor(\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly url: string,\n        public headers: { [k: string]: string },\n        public readonly pull: GraphQLSyncPullOptions<RxDocType>,\n        public readonly push: GraphQLSyncPushOptions<RxDocType>,\n        public readonly deletedFlag: string,\n        public readonly live: boolean,\n        public liveInterval: number,\n        public retryTime: number\n    ) {\n        this.client = GraphQLClient({\n            url,\n            headers\n        });\n        this.endpointHash = hash(url);\n        this._prepare();\n    }\n    public client: any;\n    public endpointHash: string;\n    public _subjects = {\n        received: new Subject(), // all documents that are received from the endpoint\n        send: new Subject(), // all documents that are send to the endpoint\n        error: new Subject(), // all errors that are received from the endpoint, emits new Error() objects\n        canceled: new BehaviorSubject(false), // true when the replication was canceled\n        active: new BehaviorSubject(false), // true when something is running, false when not\n        initialReplicationComplete: new BehaviorSubject(false) // true the initial replication-cycle is over\n    };\n    public _runningPromise: Promise<void> = PROMISE_RESOLVE_VOID;\n    public _subs: Subscription[] = [];\n\n    public _runQueueCount: number = 0;\n    public _runCount: number = 0; // used in tests\n\n    public initialReplicationComplete$: Observable<any> = undefined as any;\n\n    public received$: Observable<RxDocumentData<RxDocType>> = undefined as any;\n    public send$: Observable<any> = undefined as any;\n    public error$: Observable<any> = undefined as any;\n    public canceled$: Observable<any> = undefined as any;\n    public active$: Observable<boolean> = undefined as any;\n\n\n    /**\n     * things that are more complex to not belong into the constructor\n     */\n    _prepare() {\n        // stop sync when collection gets destroyed\n        this.collection.onDestroy.then(() => {\n            this.cancel();\n        });\n\n        // create getters for the observables\n        Object.keys(this._subjects).forEach(key => {\n            Object.defineProperty(this, key + '$', {\n                get: function () {\n                    return this._subjects[key].asObservable();\n                }\n            });\n        });\n    }\n\n    isStopped(): boolean {\n        if (this.collection.destroyed) {\n            return true;\n        }\n        if (!this.live && this._subjects.initialReplicationComplete.getValue()) {\n            return true;\n        }\n        if (this._subjects.canceled['_value']) {\n            return true;\n        }\n\n        return false;\n    }\n\n    awaitInitialReplication(): Promise<true> {\n        return firstValueFrom(\n            this.initialReplicationComplete$.pipe(\n                filter(v => v === true),\n            )\n        );\n    }\n\n    // ensures this._run() does not run in parallel\n    async run(retryOnFail = true): Promise<void> {\n        if (this.isStopped()) {\n            return;\n        }\n\n        if (this._runQueueCount > 2) {\n            return this._runningPromise;\n        }\n\n        this._runQueueCount++;\n        this._runningPromise = this._runningPromise.then(async () => {\n            this._subjects.active.next(true);\n            const willRetry = await this._run(retryOnFail);\n            this._subjects.active.next(false);\n            if (retryOnFail && !willRetry && this._subjects.initialReplicationComplete.getValue() === false) {\n                this._subjects.initialReplicationComplete.next(true);\n            }\n            this._runQueueCount--;\n        });\n        return this._runningPromise;\n    }\n\n    /**\n     * returns true if retry must be done\n     */\n    async _run(retryOnFail = true): Promise<boolean> {\n        if (this.isStopped()) {\n            return false;\n        }\n\n        this._runCount++;\n\n        /**\n         * The replication happens in the background anyways\n         * so we have to ensure that we do not slow down primary tasks.\n         * But not if it is the initial replication, because that might happen\n         * on the first inital loading where it is critical to get the data\n         * as fast as possible to decrease initial page load time.\n         */\n        if (this._subjects.initialReplicationComplete.getValue()) {\n            await this.collection.database.requestIdlePromise();\n        }\n\n        if (this.push) {\n            const ok = await this.runPush();\n            if (!ok && retryOnFail) {\n                setTimeout(() => this.run(), this.retryTime);\n                /*\n                    Because we assume that conflicts are solved on the server side,\n                    if push failed, do not attempt to pull before push was successful\n                    otherwise we do not know how to merge changes with the local state\n                */\n                return true;\n            }\n        }\n\n        if (this.pull) {\n            const ok = await this.runPull();\n            if (!ok && retryOnFail) {\n                setTimeout(() => this.run(), this.retryTime);\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    /**\n     * Pull all changes from the server,\n     * start from the last pulled change.\n     * @return true if successfully, false if something errored\n     */\n    async runPull(): Promise<boolean> {\n        if (this.isStopped()) {\n            return false;\n        }\n\n        const latestDocument = await getLastPullDocument(this.collection, this.endpointHash);\n        const latestDocumentData = latestDocument ? latestDocument : null;\n        const pullGraphQL = await this.pull.queryBuilder(latestDocumentData);\n\n        let result;\n        try {\n            result = await this.client.query(pullGraphQL.query, pullGraphQL.variables);\n            if (result.errors) {\n                if (typeof result.errors === 'string') {\n                    throw new Error(result.errors);\n                } else {\n                    const err: any = new Error('unknown errors occurred - see innerErrors for more details');\n                    err.innerErrors = result.errors;\n                    throw err;\n                }\n            }\n        } catch (err) {\n            this._subjects.error.next(err);\n            return false;\n        }\n\n        const dataPath = (this.pull as any).dataPath || ['data', Object.keys(result.data)[0]];\n        const data: any[] = objectPath.get(result, dataPath);\n\n        // optimization shortcut, do not proceed if there are no documents.\n        if (data.length === 0) {\n            return true;\n        }\n\n        const modified: any[] = (await Promise.all(data\n            .map(async (doc: any) => await (this.pull as any).modifier(doc))\n        )).filter(doc => !!doc);\n\n        /**\n         * Run schema validation in dev-mode\n         */\n        if (overwritable.isDevMode()) {\n            try {\n                modified.forEach((doc: any) => {\n                    const withoutDeleteFlag = flatClone(doc);\n                    delete withoutDeleteFlag[this.deletedFlag];\n                    this.collection.schema.validate(withoutDeleteFlag);\n                });\n            } catch (err) {\n                this._subjects.error.next(err);\n                return false;\n            }\n        }\n\n        if (this.isStopped()) {\n            return true;\n        }\n        await this.handleDocumentsFromRemote(modified);\n        modified.map((doc: any) => this._subjects.received.next(doc));\n\n        if (modified.length === 0) {\n            if (this.live) {\n                // console.log('no more docs, wait for ping');\n            } else {\n                // console.log('RxGraphQLReplicationState._run(): no more docs and not live; complete = true');\n            }\n        } else {\n            const newLatestDocument = modified[modified.length - 1];\n            await setLastPullDocument(\n                this.collection,\n                this.endpointHash,\n                newLatestDocument\n            );\n\n            /**\n             * we have more docs, re-run\n             * TODO we should have a options.pull.batchSize param\n             * and only re-run if the previous batch was 'full'\n             * this would save many duplicate requests with empty arrays as response.\n             */\n            await this.runPull();\n        }\n\n        return true;\n    }\n\n    /**\n     * @return true if successfull, false if not\n     */\n    async runPush(): Promise<boolean> {\n        if (this.isStopped()) {\n            return false;\n        }\n\n        const changesResult = await getChangesSinceLastPushSequence<RxDocType>(\n            this.collection,\n            this.endpointHash,\n            this.push.batchSize,\n        );\n\n        const changesWithDocs: { doc: RxDocumentData<RxDocType>; sequence: number; }[] = (\n            await Promise.all(\n                Array.from(changesResult.changedDocs.values()).map(async (row) => {\n                    let changedDoc = row.doc;\n                    changedDoc = await (this.push as any).modifier(changedDoc);\n                    if (!changedDoc) {\n                        return null;\n                    }\n                    return {\n                        doc: changedDoc,\n                        sequence: row.sequence\n                    };\n                })\n            )\n        ).filter(doc => !!doc) as any;\n\n        let lastSuccessfullChange: {\n            doc: RxDocumentData<RxDocType>;\n            sequence: number;\n        } | null = null;\n        try {\n            /**\n             * we cannot run all queries parallel\n             * because then we would not know\n             * where to start again on errors\n             * so we run through the docs in series\n             */\n            for (let i = 0; i < changesWithDocs.length; i++) {\n                const changeWithDoc = changesWithDocs[i];\n\n                // TODO _deleted should be required on type RxDocumentData\n                // so we do not need this check here\n                if (!changeWithDoc.doc.hasOwnProperty('_deleted')) {\n                    changeWithDoc.doc._deleted = false;\n                }\n\n                const pushObj = await this.push.queryBuilder(changeWithDoc.doc);\n\n                const result = await this.client.query(pushObj.query, pushObj.variables);\n\n                if (result.errors) {\n                    if (typeof result.errors === 'string') {\n                        throw new Error(result.errors);\n                    } else {\n                        const err: any = new Error('unknown errors occurred - see innerErrors for more details');\n                        err.innerErrors = result.errors;\n                        throw err;\n                    }\n                } else {\n                    this._subjects.send.next(changeWithDoc.doc);\n                    lastSuccessfullChange = changeWithDoc;\n                }\n            }\n        } catch (err) {\n            if (lastSuccessfullChange) {\n                await setLastPushSequence(\n                    this.collection,\n                    this.endpointHash,\n                    lastSuccessfullChange.sequence\n                );\n            }\n            this._subjects.error.next(err);\n            return false;\n        }\n\n        // all docs where successfull, so we use the seq of the changes-fetch\n        await setLastPushSequence(\n            this.collection,\n            this.endpointHash,\n            changesResult.lastSequence\n        );\n\n        if (changesResult.changedDocs.size === 0) {\n            if (this.live) {\n                // console.log('no more docs to push, wait for ping');\n            } else {\n                // console.log('RxGraphQLReplicationState._runPull(): no more docs to push and not live; complete = true');\n            }\n        } else {\n            // we have more docs, re-run\n            await this.runPush();\n        }\n\n        return true;\n    }\n\n    async handleDocumentsFromRemote(docs: any[]): Promise<boolean> {\n        const toStorageDocs: {\n            doc: RxDocumentData<RxDocType>;\n            deletedValue: boolean;\n        }[] = [];\n\n\n        const docIds: string[] = docs.map(doc => doc[this.collection.schema.primaryPath]);\n        const docsFromLocal = await this.collection.database.lockedRun(\n            () => this.collection.storageInstance.findDocumentsById(docIds, true)\n        );\n\n        for (const doc of docs) {\n            const documentId = doc[this.collection.schema.primaryPath];\n            const deletedValue = doc[this.deletedFlag];\n\n            doc._deleted = deletedValue;\n            delete doc[this.deletedFlag];\n\n            const docStateInLocalStorageInstance = docsFromLocal[documentId];\n            let newRevision = createRevisionForPulledDocument(\n                this.endpointHash,\n                doc\n            );\n            if (docStateInLocalStorageInstance) {\n                const hasHeight = getHeightOfRevision(docStateInLocalStorageInstance._rev);\n                const newRevisionHeight = hasHeight + 1;\n                newRevision = newRevisionHeight + '-' + newRevision;\n            } else {\n                newRevision = '1-' + newRevision;\n            }\n            doc._rev = newRevision;\n\n            toStorageDocs.push({\n                doc: doc,\n                deletedValue\n            });\n        }\n\n        if (toStorageDocs.length > 0) {\n            await this.collection.database.lockedRun(\n                () => this.collection.storageInstance.bulkAddRevisions(\n                    toStorageDocs.map(row => _handleToStorageInstance(this.collection, row.doc))\n                )\n            );\n        }\n\n        return true;\n    }\n\n    cancel(): Promise<any> {\n        if (this.isStopped()) {\n            return PROMISE_RESOLVE_FALSE;\n        }\n        this._subs.forEach(sub => sub.unsubscribe());\n        this._subjects.canceled.next(true);\n        return PROMISE_RESOLVE_TRUE;\n    }\n\n    setHeaders(headers: { [k: string]: string }): void {\n        this.client = GraphQLClient({\n            url: this.url,\n            headers\n        });\n    }\n}\n\nexport function syncGraphQL(\n    this: RxCollection,\n    {\n        url,\n        headers = {},\n        waitForLeadership = true,\n        pull,\n        push,\n        deletedFlag,\n        live = false,\n        liveInterval = 1000 * 10, // in ms\n        retryTime = 1000 * 5, // in ms\n        autoStart = true // if this is false, the replication does nothing at start\n    }: any\n) {\n    const collection = this;\n\n    // fill in defaults for pull & push\n    if (pull) {\n        if (!pull.modifier) pull.modifier = DEFAULT_MODIFIER;\n    }\n    if (push) {\n        if (!push.modifier) push.modifier = DEFAULT_MODIFIER;\n    }\n\n    const replicationState = new RxGraphQLReplicationState(\n        collection,\n        url,\n        headers,\n        pull,\n        push,\n        deletedFlag,\n        live,\n        liveInterval,\n        retryTime\n    );\n\n    if (!autoStart) {\n        return replicationState;\n    }\n\n    // run internal so .sync() does not have to be async\n    const waitTillRun: any = (\n        waitForLeadership &&\n        this.database.multiInstance // do not await leadership if not multiInstance\n    ) ? this.database.waitForLeadership() : PROMISE_RESOLVE_VOID;\n    waitTillRun.then(() => {\n        if (collection.destroyed) {\n            return;\n        }\n\n        // trigger run once\n        replicationState.run();\n\n        // start sync-interval\n        if (replicationState.live) {\n\n            if (pull) {\n                (async () => {\n                    while (!replicationState.isStopped()) {\n                        await promiseWait(replicationState.liveInterval);\n                        if (replicationState.isStopped()) {\n                            return;\n                        }\n                        await replicationState.run(\n                            // do not retry on liveInterval-runs because they might stack up\n                            // when failing\n                            false\n                        );\n                    }\n                })();\n            }\n\n            if (push) {\n                /**\n                 * When a document is written to the collection,\n                 * we might have to run the replication run() once\n                 */\n                const changeEventsSub = collection.$.pipe(\n                    filter(cE => !cE.isLocal)\n                )\n                    .subscribe(changeEvent => {\n                        if (replicationState.isStopped()) {\n                            return;\n                        }\n                        const doc = getDocumentDataOfRxChangeEvent(changeEvent);\n                        const rev = doc._rev;\n                        if (\n                            rev &&\n                            !wasRevisionfromPullReplication(\n                                replicationState.endpointHash,\n                                rev\n                            )\n                        ) {\n                            replicationState.run();\n                        }\n                    });\n                replicationState._subs.push(changeEventsSub);\n            }\n        }\n    });\n\n    return replicationState;\n}\n\nexport * from './helper';\nexport * from './crawling-checkpoint';\nexport * from './graphql-schema-from-rx-schema';\nexport * from './query-builder-from-rx-schema';\n\nexport const rxdb = true;\nexport const prototypes = {\n    RxCollection: (proto: any) => {\n        proto.syncGraphQL = syncGraphQL;\n    }\n};\n\nexport const RxDBReplicationGraphQLPlugin: RxPlugin = {\n    name: 'replication-graphql',\n    rxdb,\n    prototypes\n};\n"],"file":"index.js"}