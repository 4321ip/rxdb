{"version":3,"sources":["../../../../src/plugins/lokijs/rx-storage-key-object-instance-loki.ts"],"names":["Subject","newRxError","createRevision","ensureNotFalsy","flatClone","now","parseRevision","promiseWait","randomCouchString","CHANGES_COLLECTION_SUFFIX","closeLokiCollections","getLokiDatabase","getLokiEventKey","getLokiLeaderElector","handleRemoteRequest","LOKIJS_COLLECTION_DEFAULT_OPTIONS","mustUseLocalState","OPEN_LOKIJS_STORAGE_INSTANCES","removeLokiLeaderElectorReference","requestRemoteInstance","stripLokiKey","createLokiKeyObjectStorageInstance","storage","params","databaseSettings","instance","RxStorageKeyObjectInstanceLoki","databaseName","collectionName","internals","options","multiInstance","leaderElector","awaitLeadership","then","localState","createLokiKeyValueLocalState","databaseState","collectionOptions","Object","assign","collection","indices","unique","database","addCollection","collections","changesCollectionName","changesCollectionOptions","changesCollection","instanceId","changes$","closed","add","broadcastChannel","addEventListener","msg","bulkWrite","documentWrites","length","args","startTime","ret","success","error","writeRowById","Map","eventBulk","id","events","forEach","writeRow","document","_id","set","writeDoc","docInDb","by","previous","newRevHeight","_rev","height","newRevision","err","isError","status","documentId","toLoki","$loki","$lastWriteAt","update","insertData","insert","endTime","event","operation","doc","_deleted","previousDoc","eventId","storageChangeEvent","change","push","saveQueue","addWrite","next","findLocalDocumentsById","ids","documentInDb","changeStream","asObservable","close","complete","remove","removeCollection","name"],"mappings":"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","sourcesContent":["import type { ChangeEvent } from 'event-reduce-js';\nimport { Observable, Subject } from 'rxjs';\nimport { newRxError } from '../../rx-error';\nimport type {\n    BulkWriteLocalRow,\n    EventBulk,\n    LokiDatabaseSettings,\n    LokiLocalDatabaseState,\n    LokiSettings,\n    LokiStorageInternals,\n    RxKeyObjectStorageInstanceCreationParams,\n    RxLocalDocumentData,\n    RxLocalStorageBulkWriteResponse,\n    RxStorageBulkWriteLocalError,\n    RxStorageChangeEvent,\n    RxStorageKeyObjectInstance\n} from '../../types';\nimport {\n    createRevision,\n    ensureNotFalsy,\n    flatClone,\n    now,\n    parseRevision,\n    promiseWait,\n    randomCouchString\n} from '../../util';\nimport {\n    CHANGES_COLLECTION_SUFFIX,\n    closeLokiCollections,\n    getLokiDatabase,\n    getLokiEventKey,\n    getLokiLeaderElector,\n    handleRemoteRequest,\n    LOKIJS_COLLECTION_DEFAULT_OPTIONS,\n    mustUseLocalState,\n    OPEN_LOKIJS_STORAGE_INSTANCES,\n    removeLokiLeaderElectorReference,\n    requestRemoteInstance,\n    stripLokiKey\n} from './lokijs-helper';\nimport type {\n    Collection\n} from 'lokijs';\nimport type { RxStorageLoki } from './rx-storage-lokijs';\n\nlet instanceId = 1;\n\nexport class RxStorageKeyObjectInstanceLoki implements RxStorageKeyObjectInstance<LokiStorageInternals, LokiSettings> {\n\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxLocalDocumentData>>> = new Subject();\n\n    public instanceId = instanceId++;\n    public closed = false;\n\n    constructor(\n        public readonly storage: RxStorageLoki,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly internals: LokiStorageInternals,\n        public readonly options: Readonly<LokiSettings>,\n        public readonly databaseSettings: LokiDatabaseSettings\n    ) {\n        OPEN_LOKIJS_STORAGE_INSTANCES.add(this);\n        if (this.internals.leaderElector) {\n            this.internals.leaderElector.awaitLeadership().then(() => {\n                // this instance is leader now, so it has to reply to queries from other instances\n                ensureNotFalsy(this.internals.leaderElector).broadcastChannel\n                    .addEventListener('message', async (msg) => handleRemoteRequest(this, msg));\n            });\n        }\n    }\n\n    async bulkWrite<RxDocType>(documentWrites: BulkWriteLocalRow<RxDocType>[]): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\n        if (documentWrites.length === 0) {\n            throw newRxError('P2', {\n                args: {\n                    documentWrites\n                }\n            });\n        }\n\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'bulkWrite', [documentWrites]);\n        }\n\n        const startTime = now();\n        await promiseWait(0);\n\n        const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\n            success: {},\n            error: {}\n        };\n        const writeRowById: Map<string, BulkWriteLocalRow<RxDocType>> = new Map();\n        const eventBulk: EventBulk<RxStorageChangeEvent<RxLocalDocumentData>> = {\n            id: randomCouchString(10),\n            events: []\n        };\n        documentWrites.forEach(writeRow => {\n            const id = writeRow.document._id;\n            writeRowById.set(id, writeRow);\n            const writeDoc = flatClone(writeRow.document);\n            const docInDb = localState.collection.by('_id', id);\n            const previous = writeRow.previous ? writeRow.previous : localState.collection.by('_id', id);\n            const newRevHeight = previous ? parseRevision(previous._rev).height + 1 : 1;\n            const newRevision = newRevHeight + '-' + createRevision(writeRow.document);\n            writeDoc._rev = newRevision;\n            if (docInDb) {\n                if (\n                    !writeRow.previous ||\n                    docInDb._rev !== writeRow.previous._rev\n                ) {\n                    // conflict error\n                    const err: RxStorageBulkWriteLocalError<RxDocType> = {\n                        isError: true,\n                        status: 409,\n                        documentId: id,\n                        writeRow: writeRow\n                    };\n                    ret.error[id] = err;\n                    return;\n                } else {\n                    const toLoki: any = flatClone(writeDoc);\n                    toLoki.$loki = docInDb.$loki;\n                    toLoki.$lastWriteAt = startTime;\n                    localState.collection.update(toLoki);\n                }\n            } else {\n                const insertData: any = flatClone(writeDoc);\n                insertData.$lastWriteAt = startTime;\n                localState.collection.insert(insertData);\n            }\n\n            ret.success[id] = stripLokiKey(writeDoc);\n\n            const endTime = now();\n\n            let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\n            if (!writeRow.previous) {\n                // was insert\n                event = {\n                    operation: 'INSERT',\n                    doc: writeDoc,\n                    id: id,\n                    previous: null\n                };\n            } else if (writeRow.document._deleted) {\n                // was delete\n\n                // we need to add the new revision to the previous doc\n                // so that the eventkey is calculated correctly.\n                // Is this a hack? idk.\n                const previousDoc = flatClone(writeRow.previous);\n                previousDoc._rev = newRevision;\n\n                event = {\n                    operation: 'DELETE',\n                    doc: null,\n                    id,\n                    previous: previousDoc\n                };\n            } else {\n                // was update\n                event = {\n                    operation: 'UPDATE',\n                    doc: writeDoc,\n                    id: id,\n                    previous: writeRow.previous\n                };\n            }\n\n            if (\n                writeRow.document._deleted &&\n                (\n                    !writeRow.previous ||\n                    writeRow.previous._deleted\n                )\n            ) {\n                /**\n                 * An already deleted document was added to the storage engine,\n                 * do not emit an event because it does not affect anything.\n                 */\n            } else {\n                const doc: RxLocalDocumentData<RxDocType> = event.operation === 'DELETE' ? event.previous as any : event.doc as any;\n                const eventId = getLokiEventKey(true, doc._id, doc._rev ? doc._rev : '');\n                const storageChangeEvent: RxStorageChangeEvent<RxLocalDocumentData<RxDocType>> = {\n                    eventId,\n                    documentId: id,\n                    change: event,\n                    startTime,\n                    endTime\n                };\n                eventBulk.events.push(storageChangeEvent);\n            }\n        });\n\n        localState.databaseState.saveQueue.addWrite();\n        this.changes$.next(eventBulk);\n        return ret;\n    }\n    async findLocalDocumentsById<RxDocType = any>(ids: string[]): Promise<{ [documentId: string]: RxLocalDocumentData<RxDocType> }> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'findLocalDocumentsById', [ids]);\n        }\n\n        await promiseWait(0);\n        const ret: { [documentId: string]: RxLocalDocumentData<RxDocType> } = {};\n        ids.forEach(id => {\n            const documentInDb = localState.collection.by('_id', id);\n            if (\n                documentInDb &&\n                !documentInDb._deleted\n            ) {\n                ret[id] = stripLokiKey(documentInDb);\n            }\n        });\n        return ret;\n    }\n    changeStream(): Observable<EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any; }>>>> {\n        return this.changes$.asObservable();\n    }\n    async close(): Promise<void> {\n        this.closed = true;\n        this.changes$.complete();\n        OPEN_LOKIJS_STORAGE_INSTANCES.delete(this);\n        if (this.internals.localState) {\n            const localState = await ensureNotFalsy(this.internals.localState);\n            await closeLokiCollections(\n                this.databaseName,\n                [\n                    ensureNotFalsy(localState.collection),\n                    ensureNotFalsy(localState.changesCollection)\n                ]\n            );\n        }\n        removeLokiLeaderElectorReference(this.storage, this.databaseName);\n    }\n    async remove(): Promise<void> {\n        const localState = await mustUseLocalState(this);\n        if (!localState) {\n            return requestRemoteInstance(this, 'remove', []);\n        }\n        localState.databaseState.database.removeCollection(localState.collection.name);\n        localState.databaseState.database.removeCollection(localState.changesCollection.name);\n        this.close();\n    }\n}\n\n\nexport async function createLokiKeyValueLocalState(\n    params: RxKeyObjectStorageInstanceCreationParams<LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<LokiLocalDatabaseState> {\n    if (!params.options) {\n        params.options = {};\n    }\n    const databaseState = await getLokiDatabase(\n        params.databaseName,\n        databaseSettings\n    );\n\n    const collectionOptions: Partial<CollectionOptions<RxLocalDocumentData>> = Object.assign(\n        {},\n        params.options.collection,\n        {\n            indices: [],\n            unique: ['_id']\n        } as any,\n        LOKIJS_COLLECTION_DEFAULT_OPTIONS\n    );\n\n    const collection: Collection = databaseState.database.addCollection(\n        params.collectionName,\n        collectionOptions\n    );\n    databaseState.collections[params.collectionName] = collection;\n\n    const changesCollectionName = params.collectionName + CHANGES_COLLECTION_SUFFIX;\n    const changesCollectionOptions = Object.assign({\n        unique: ['eventId'],\n        indices: ['sequence']\n    }, LOKIJS_COLLECTION_DEFAULT_OPTIONS);\n    const changesCollection: Collection = databaseState.database.addCollection(\n        changesCollectionName,\n        changesCollectionOptions\n    );\n    databaseState.collections[changesCollectionName] = collection;\n\n    return {\n        changesCollection,\n        collection,\n        databaseState\n    }\n}\n\nexport async function createLokiKeyObjectStorageInstance(\n    storage: RxStorageLoki,\n    params: RxKeyObjectStorageInstanceCreationParams<LokiSettings>,\n    databaseSettings: LokiDatabaseSettings\n): Promise<RxStorageKeyObjectInstanceLoki> {\n    const internals: LokiStorageInternals = {};\n\n\n    if (params.multiInstance) {\n        const leaderElector = getLokiLeaderElector(storage, params.databaseName);\n        internals.leaderElector = leaderElector;\n    } else {\n        // optimisation shortcut, directly create db is non multi instance.\n        internals.localState = createLokiKeyValueLocalState(params, databaseSettings);\n        await internals.localState;\n    }\n\n    const instance = new RxStorageKeyObjectInstanceLoki(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        internals,\n        params.options,\n        databaseSettings\n    );\n\n    /**\n     * Directly create the localState if the db becomes leader.\n     */\n    if (params.multiInstance) {\n        ensureNotFalsy(internals.leaderElector)\n            .awaitLeadership()\n            .then(() => mustUseLocalState(instance));\n    }\n\n\n    return instance;\n}\n"],"file":"rx-storage-key-object-instance-loki.js"}