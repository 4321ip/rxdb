{"version":3,"sources":["../../../src/plugins/encryption.ts"],"names":["storePasswordHashIntoDatabase","rxDatabase","password","PROMISE_RESOLVE_FALSE","pwHash","pwHashDocumentId","localDocumentsStore","pwHashDoc","docData","_id","value","_attachments","bulkWrite","document","destroy","passwordHash","existingPasswordHash","minPassLength","encrypt","encrypted","AES","toString","decrypt","cipherText","decrypted","cryptoEnc","_encryptString","_decryptString","encryptedValue","rxdb","prototypes","Crypter","proto","overwritable","validatePassword","length","RxDBEncryptionPlugin","name","hooks","createRxDatabase","db"],"mappings":"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","sourcesContent":["/**\n * this plugin adds the encryption-capabilities to rxdb\n * It's using crypto-js/aes for password-encryption\n * @link https://github.com/brix/crypto-js\n */\n\nimport AES from 'crypto-js/aes';\nimport * as cryptoEnc from 'crypto-js/enc-utf8';\n\nimport {\n    newRxTypeError,\n    newRxError\n} from '../rx-error';\n\nimport type {\n    Crypter\n} from '../crypter';\nimport type {\n    RxPlugin,\n    RxDatabase,\n    RxLocalDocumentData\n} from '../types';\nimport { hash, PROMISE_RESOLVE_FALSE } from '../util';\nimport { findLocalDocument } from '../rx-storage-helper';\n\nconst minPassLength = 8;\n\nexport function encrypt(value: string, password: any): string {\n    const encrypted = AES.encrypt(value, password);\n    return encrypted.toString();\n}\n\nexport function decrypt(cipherText: string, password: any): string {\n    const decrypted = AES.decrypt(cipherText, password);\n    return decrypted.toString(cryptoEnc);\n}\n\nconst _encryptString = function (this: Crypter, value: string) {\n    return encrypt(value, this.password);\n};\n\nconst _decryptString = function (this: Crypter, encryptedValue: string): string {\n    const decrypted = decrypt(encryptedValue, this.password);\n    return decrypted;\n};\n\n\nexport type PasswordHashDocument = RxLocalDocumentData<{\n    value: string;\n}>;\n\n/**\n * validates and inserts the password hash into the internal collection\n * to ensure there is/was no other instance with a different password\n * which would cause strange side effects when both instances save into the same db\n */\nexport async function storePasswordHashIntoDatabase(\n    rxDatabase: RxDatabase\n): Promise<boolean> {\n    if (!rxDatabase.password) {\n        return PROMISE_RESOLVE_FALSE;\n    }\n    const pwHash = hash(rxDatabase.password);\n    const pwHashDocumentId = 'pwHash';\n\n    const pwHashDoc = await findLocalDocument<PasswordHashDocument>(\n        rxDatabase.localDocumentsStore,\n        pwHashDocumentId\n    );\n    if (!pwHashDoc) {\n        const docData: PasswordHashDocument = {\n            _id: pwHashDocumentId,\n            value: pwHash,\n            _attachments: {}\n        };\n        await rxDatabase.localDocumentsStore.bulkWrite([{\n            document: docData\n        }]);\n        return true;\n    } else if (pwHash !== pwHashDoc.value) {\n        // different hash was already set by other instance\n        await rxDatabase.destroy();\n        throw newRxError('DB1', {\n            passwordHash: hash(rxDatabase.password),\n            existingPasswordHash: pwHashDoc.value\n        });\n    } else {\n        return true;\n    }\n}\n\n\n\n\nexport const rxdb = true;\nexport const prototypes = {\n    /**\n     * set crypto-functions for the Crypter.prototype\n     */\n    Crypter: (proto: any) => {\n        proto._encryptString = _encryptString;\n        proto._decryptString = _decryptString;\n    }\n};\nexport const overwritable = {\n    validatePassword: function (password: any) {\n        if (password && typeof password !== 'string') {\n            throw newRxTypeError('EN1', {\n                password\n            });\n        }\n        if (password && password.length < minPassLength) {\n            throw newRxError('EN2', {\n                minPassLength,\n                password\n            });\n        }\n    }\n};\n\nexport const RxDBEncryptionPlugin: RxPlugin = {\n    name: 'encryption',\n    rxdb,\n    prototypes,\n    overwritable,\n    hooks: {\n        createRxDatabase: (db: RxDatabase) => {\n            return storePasswordHashIntoDatabase(db);\n        }\n    }\n};\n"],"file":"encryption.js"}