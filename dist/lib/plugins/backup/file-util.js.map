{"version":3,"sources":["../../../../src/plugins/backup/file-util.ts"],"names":["setMeta","options","meta","loc","metaFileLocation","writeJsonToFile","getMeta","Promise","res","rej","fs","readFile","err","data","metaContent","JSON","parse","location","writeToFile","stringify","writeFile","ensureFolderExists","folderPath","existsSync","mkdirSync","recursive","clearFolder","deleteFolder","rmdirSync","prepareFolders","database","directory","metaLoc","currentTime","metaData","createdAt","updatedAt","collectionStates","writeFileSync","Object","keys","collections","forEach","collectionName","path","join","documentFolder","docId"],"mappings":"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","sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport {\n    BackupMetaFileContent,\n    BackupOptions,\n    RxDatabase\n} from '../../types';\nimport { now } from '../../util';\n\n/**\n * ensure that the given folder exists\n */\nexport function ensureFolderExists(folderPath: string): void {\n    if (!fs.existsSync(folderPath)) {\n        fs.mkdirSync(folderPath, { recursive: true });\n    }\n}\n\n/**\n * deletes and recreates the folder\n */\nexport function clearFolder(folderPath: string): void {\n    deleteFolder(folderPath);\n    ensureFolderExists(folderPath);\n}\n\nexport function deleteFolder(folderPath: string): void {\n    // only remove if exists to not raise warning\n    if (fs.existsSync(folderPath)) {\n        fs.rmdirSync(folderPath, { recursive: true });\n    }\n}\n\nexport function prepareFolders(\n    database: RxDatabase,\n    options: BackupOptions\n) {\n    ensureFolderExists(options.directory);\n\n    const metaLoc = metaFileLocation(options);\n\n    if (!fs.existsSync(metaLoc)) {\n        const currentTime = now();\n        const metaData: BackupMetaFileContent = {\n            createdAt: currentTime,\n            updatedAt: currentTime,\n            collectionStates: {}\n        };\n        fs.writeFileSync(metaLoc, JSON.stringify(metaData), 'utf-8');\n    }\n\n    Object.keys(database.collections).forEach(collectionName => {\n        ensureFolderExists(\n            path.join(\n                options.directory,\n                collectionName\n            )\n        );\n    });\n}\n\nexport async function writeToFile(\n    location: string,\n    data: string | Buffer\n): Promise<void> {\n    return new Promise(function (res, rej) {\n        fs.writeFile(\n            location,\n            data,\n            'utf-8',\n            (err) => {\n                if (err) {\n                    rej(err);\n                } else {\n                    res();\n                }\n            }\n        );\n    });\n}\n\nexport async function writeJsonToFile(\n    location: string,\n    data: any\n): Promise<void> {\n    return writeToFile(\n        location,\n        JSON.stringify(data)\n    );\n}\n\nexport function metaFileLocation(options: BackupOptions): string {\n    return path.join(\n        options.directory,\n        'backup_meta.json'\n    );\n}\n\nexport async function getMeta(options: BackupOptions): Promise<BackupMetaFileContent> {\n    const loc = metaFileLocation(options);\n    return new Promise((res, rej) => {\n        fs.readFile(loc, 'utf-8', (err, data) => {\n            if (err) {\n                rej(err);\n            } else {\n                const metaContent = JSON.parse(data);\n                res(metaContent);\n            }\n        });\n    });\n}\n\nexport async function setMeta(\n    options: BackupOptions,\n    meta: BackupMetaFileContent\n): Promise<void> {\n    const loc = metaFileLocation(options);\n    return writeJsonToFile(loc, meta);\n}\n\nexport function documentFolder(\n    options: BackupOptions,\n    docId: string\n): string {\n    return path.join(\n        options.directory,\n        docId\n    );\n}\n"],"file":"file-util.js"}